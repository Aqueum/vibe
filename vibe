#!/bin/bash
# vibe â€” a thin wrapper around ClaudeBox for per-project YOLO vibe coding sessions
# https://github.com/Aqueum/vibe
#
# Usage:
#   vibe                  # cd to your project folder, then just run this
#   vibe <project-name>   # launch by name from anywhere (uses VIBE_PROJECTS_DIR)
#   vibe --rebuild        # force rebuild of ClaudeBox image
#   vibe --list           # list available projects
#   vibe --help           # show this help

set -euo pipefail

# â”€â”€ Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CONFIG_FILE="${VIBE_CONFIG:-$HOME/.vibe/config}"
TOKENS_FILE="$HOME/.vibe/tokens"

if [ -f "$CONFIG_FILE" ]; then
  # shellcheck source=/dev/null
  source "$CONFIG_FILE"
fi

PROJECTS_DIR="${VIBE_PROJECTS_DIR:-$HOME/Projects}"

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
usage() {
  grep '^#' "$0" | grep -v '#!/' | sed 's/^# \?//'
  exit 0
}

require() {
  if ! command -v "$1" &>/dev/null; then
    echo "  âœ— '$1' not found. $2"
    exit 1
  fi
}

# Detect GitHub owner/repo from git remote in current directory
detect_github_repo() {
  local url
  url=$(git remote get-url origin 2>/dev/null) || return 1
  # Handle both https://github.com/owner/repo.git and git@github.com:owner/repo.git
  if [[ "$url" =~ github\.com[:/]([^/]+/[^/.]+)(\.git)?$ ]]; then
    echo "${BASH_REMATCH[1]}"
    return 0
  fi
  return 1
}

# Look up saved token for a repo
lookup_token() {
  local repo="$1"
  [ -f "$TOKENS_FILE" ] || return 0
  grep "^${repo}=" "$TOKENS_FILE" 2>/dev/null | cut -d= -f2 || true
}

# Save a token for a repo (replaces existing entry)
save_token() {
  local repo="$1" token="$2"
  mkdir -p "$(dirname "$TOKENS_FILE")"
  touch "$TOKENS_FILE"
  # Remove any existing entry for this repo, then append new one
  local tmp
  tmp=$(mktemp)
  grep -v "^${repo}=" "$TOKENS_FILE" > "$tmp" || true
  echo "${repo}=${token}" >> "$tmp"
  mv "$tmp" "$TOKENS_FILE"
  chmod 600 "$TOKENS_FILE"
}

# Interactive token setup â€” walks the user through creating a fine-grained PAT
setup_token() {
  local repo="$1"
  local owner
  owner=$(echo "$repo" | cut -d/ -f1)

  echo ""
  echo "  No GitHub token found for $repo."
  echo ""
  echo "  I'll open GitHub so you can create a fine-grained token."
  echo "  On that page:"
  echo "    1. Give it a name, e.g.: vibe-$(echo "$repo" | cut -d/ -f2)"
  echo "    2. Set an expiry (90 days is a good default)"
  echo "    3. Under 'Repository access' â†’ 'Only select repositories'"
  echo "       â†’ choose $(echo "$repo" | cut -d/ -f2)"
  echo "    4. Under 'Permissions' enable:"
  echo "         Contents        â†’ Read and write"
  echo "         Metadata        â†’ Read-only  (auto-selected)"
  echo "         Pull requests   â†’ Read and write"
  echo "    5. Click 'Generate token' and copy it"
  echo ""
  read -rp "  Press Enter to open GitHub in your browser (or Ctrl+C to skip)..."
  open "https://github.com/settings/personal-access-tokens/new"
  echo ""
  read -rsp "  Paste your token (input is hidden): " input_token
  echo ""

  if [ -z "$input_token" ]; then
    echo ""
    echo "  No token entered â€” launching without GitHub auth."
    GITHUB_TOKEN=""
    return
  fi

  save_token "$repo" "$input_token"
  echo "  âœ“ Token saved â€” you won't be asked again for this repo."
  GITHUB_TOKEN="$input_token"
}

# â”€â”€ Flags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REBUILD=false
while [[ "${1:-}" == --* ]]; do
  case "$1" in
    --rebuild) REBUILD=true; shift ;;
    --list)
      echo "Projects in $PROJECTS_DIR:"
      ls "$PROJECTS_DIR"
      exit 0
      ;;
    --help|-h) usage ;;
    *) echo "Unknown flag: $1"; exit 1 ;;
  esac
done

# â”€â”€ Resolve workspace â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ "$#" -eq 0 ]; then
  WORKSPACE="$(pwd)"
  PROJECT_NAME="$(basename "$WORKSPACE")"
else
  PROJECT_NAME="$1"
  if [ -d "$PROJECT_NAME" ]; then
    WORKSPACE="$(cd "$PROJECT_NAME" && pwd)"
    PROJECT_NAME="$(basename "$WORKSPACE")"
  else
    WORKSPACE="$PROJECTS_DIR/$PROJECT_NAME"
    if [ ! -d "$WORKSPACE" ]; then
      echo "  Error: Project not found: $WORKSPACE"
      echo ""
      echo "  Available projects:"
      ls "$PROJECTS_DIR"
      exit 1
    fi
  fi
fi

# â”€â”€ Checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
require claudebox "Install from: https://github.com/RchGrav/claudebox"

if [ -z "${ANTHROPIC_API_KEY:-}" ]; then
  echo "  âœ— ANTHROPIC_API_KEY is not set."
  echo "    Add this to your ~/.zshrc:  export ANTHROPIC_API_KEY=sk-ant-..."
  exit 1
fi

# â”€â”€ GitHub token handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GITHUB_TOKEN=""
cd "$WORKSPACE"

GITHUB_REPO=$(detect_github_repo || true)

if [ -n "$GITHUB_REPO" ]; then
  GITHUB_TOKEN=$(lookup_token "$GITHUB_REPO")
  if [ -z "$GITHUB_TOKEN" ]; then
    setup_token "$GITHUB_REPO"
  fi
fi

# â”€â”€ Launch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "  ðŸš€ vibe session starting"
echo "     project : $PROJECT_NAME"
echo "     path    : $WORKSPACE"
[ -n "${GITHUB_REPO:-}" ] && echo "     github  : $GITHUB_REPO"
echo ""

CLAUDEBOX_ARGS=(--dangerously-skip-permissions)
[ "$REBUILD" = true ] && CLAUDEBOX_ARGS+=(--rebuild)

if [ -n "$GITHUB_TOKEN" ]; then
  GITHUB_TOKEN="$GITHUB_TOKEN" claudebox "${CLAUDEBOX_ARGS[@]}"
else
  claudebox "${CLAUDEBOX_ARGS[@]}"
fi
