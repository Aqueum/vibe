#!/bin/bash
# vibe â€” a thin wrapper around ClaudeBox for per-project YOLO vibe coding sessions
# https://github.com/Aqueum/vibe
#
# Usage:
#   vibe                  # cd to your project folder, then just run this
#   vibe <project-name>   # launch by name from anywhere (uses VIBE_PROJECTS_DIR)
#   vibe --rebuild        # force rebuild of ClaudeBox image
#   vibe --list           # list available projects
#   vibe --help           # show this help

set -euo pipefail

# â”€â”€ Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CONFIG_FILE="${VIBE_CONFIG:-$HOME/.vibe/config}"
TOKENS_FILE="$HOME/.vibe/tokens"
SKIPPED_FILE="$HOME/.vibe/skipped"

if [ -f "$CONFIG_FILE" ]; then
  # shellcheck source=/dev/null
  source "$CONFIG_FILE"
fi

PROJECTS_DIR="${VIBE_PROJECTS_DIR:-$HOME/Projects}"

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
usage() {
  grep '^#' "$0" | grep -v '#!/' | sed 's/^# \?//'
  exit 0
}

require() {
  if ! command -v "$1" &>/dev/null; then
    echo "  âœ— '$1' not found. $2"
    exit 1
  fi
}

# Three-way prompt: returns "yes", "no", or "never"
ask_yes_no_never() {
  local prompt="$1"
  local reply
  while true; do
    read -rp "  $prompt [Y/n/never]: " reply
    reply="${reply:-y}"
    case "${reply,,}" in
      y|yes)   echo "yes";   return ;;
      n|no)    echo "no";    return ;;
      never)   echo "never"; return ;;
      *) echo "  Please answer y, n, or never." ;;
    esac
  done
}

ask_yes_no() {
  local prompt="$1" default="${2:-y}"
  local options
  [[ "$default" == "n" ]] && options="y/N" || options="Y/n"
  local reply
  read -rp "  $prompt [$options]: " reply
  reply="${reply:-$default}"
  [[ "${reply,,}" == "y" ]]
}

# â”€â”€ Git helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Detect GitHub owner/repo from git remote in current directory
detect_github_repo() {
  local url
  url=$(git remote get-url origin 2>/dev/null) || return 1
  if [[ "$url" =~ github\.com[:/]([^/]+/[^/.]+)(\.git)?$ ]]; then
    echo "${BASH_REMATCH[1]}"
    return 0
  fi
  return 1
}

# Check if this workspace has been marked as "never ask about GitHub"
is_github_skipped() {
  [ -f "$SKIPPED_FILE" ] || return 1
  grep -qxF "$WORKSPACE" "$SKIPPED_FILE"
}

# Mark this workspace so we never ask about GitHub again
mark_github_skipped() {
  mkdir -p "$(dirname "$SKIPPED_FILE")"
  echo "$WORKSPACE" >> "$SKIPPED_FILE"
  echo "  âœ“ Got it â€” won't ask about GitHub for this project again."
}

# Ensure we have at least one commit (required before pushing to GitHub)
ensure_initial_commit() {
  if ! git rev-parse --git-dir &>/dev/null; then
    echo "  Initialising git repository..."
    git init
  fi

  if ! git rev-parse HEAD &>/dev/null 2>&1; then
    # No commits yet â€” stage whatever exists (may be nothing) and commit
    git add -A 2>/dev/null || true
    if ! git commit -m "Initial commit" --allow-empty-message 2>/dev/null; then
      git commit --allow-empty -m "Initial commit"
    fi
    echo "  âœ“ Initial commit created."
  fi
}

# Offer to create a new GitHub repo for the current workspace
create_github_repo() {
  echo ""
  echo "  No GitHub repo found for this project."
  echo ""

  local answer
  answer=$(ask_yes_no_never "Create a GitHub repo for it?")

  case "$answer" in
    never)
      mark_github_skipped
      return
      ;;
    no)
      echo "  Skipping â€” launching without GitHub."
      return
      ;;
  esac

  # Repo name
  local repo_name
  read -rp "  Repo name [$PROJECT_NAME]: " repo_name
  repo_name="${repo_name:-$PROJECT_NAME}"

  # Visibility
  local visibility="private"
  ask_yes_no "Make it public?" n && visibility="public"

  # Description
  local description=""
  read -rp "  Description (optional): " description

  # Make sure we have a git repo with at least one commit
  ensure_initial_commit

  # Get GitHub username
  local gh_user
  gh_user=$(gh api user --jq '.login' 2>/dev/null) || {
    echo "  âœ— Not logged in to GitHub CLI. Run: gh auth login"
    return
  }

  echo "  Creating $visibility repo $gh_user/$repo_name on GitHub..."

  local create_args=("$repo_name" "--$visibility" "--source=." "--push")
  [ -n "$description" ] && create_args+=("--description=$description")

  if gh repo create "${create_args[@]}"; then
    GITHUB_REPO="$gh_user/$repo_name"
    echo "  âœ“ Repo created: https://github.com/$GITHUB_REPO"
  else
    echo "  âœ— Repo creation failed â€” launching without GitHub."
  fi
}

# â”€â”€ Token helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

lookup_token() {
  local repo="$1"
  [ -f "$TOKENS_FILE" ] || return 0
  grep "^${repo}=" "$TOKENS_FILE" 2>/dev/null | cut -d= -f2 || true
}

save_token() {
  local repo="$1" token="$2"
  mkdir -p "$(dirname "$TOKENS_FILE")"
  touch "$TOKENS_FILE"
  local tmp
  tmp=$(mktemp)
  grep -v "^${repo}=" "$TOKENS_FILE" > "$tmp" || true
  echo "${repo}=${token}" >> "$tmp"
  mv "$tmp" "$TOKENS_FILE"
  chmod 600 "$TOKENS_FILE"
}

setup_token() {
  local repo="$1"

  echo ""
  echo "  No GitHub token found for $repo."
  echo ""
  echo "  I'll open GitHub so you can create a fine-grained token."
  echo "  On that page:"
  echo "    1. Give it a name, e.g.: vibe-$(echo "$repo" | cut -d/ -f2)"
  echo "    2. Set an expiry (90 days is a good default)"
  echo "    3. Under 'Repository access' â†’ 'Only select repositories'"
  echo "       â†’ choose $(echo "$repo" | cut -d/ -f2)"
  echo "    4. Under 'Permissions' enable:"
  echo "         Contents        â†’ Read and write"
  echo "         Metadata        â†’ Read-only  (auto-selected)"
  echo "         Pull requests   â†’ Read and write"
  echo "    5. Click 'Generate token' and copy it"
  echo ""
  read -rp "  Press Enter to open GitHub in your browser (or Ctrl+C to skip)..."
  open "https://github.com/settings/personal-access-tokens/new"
  echo ""
  read -rsp "  Paste your token (input is hidden): " input_token
  echo ""

  if [ -z "$input_token" ]; then
    echo "  No token entered â€” launching without GitHub auth."
    GITHUB_TOKEN=""
    return
  fi

  save_token "$repo" "$input_token"
  echo "  âœ“ Token saved â€” you won't be asked again for this repo."
  GITHUB_TOKEN="$input_token"
}

# â”€â”€ Flags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REBUILD=false
while [[ "${1:-}" == --* ]]; do
  case "$1" in
    --rebuild) REBUILD=true; shift ;;
    --list)
      echo "Projects in $PROJECTS_DIR:"
      ls "$PROJECTS_DIR"
      exit 0
      ;;
    --help|-h) usage ;;
    *) echo "Unknown flag: $1"; exit 1 ;;
  esac
done

# â”€â”€ Resolve workspace â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ "$#" -eq 0 ]; then
  WORKSPACE="$(pwd)"
  PROJECT_NAME="$(basename "$WORKSPACE")"
else
  PROJECT_NAME="$1"
  if [ -d "$PROJECT_NAME" ]; then
    WORKSPACE="$(cd "$PROJECT_NAME" && pwd)"
    PROJECT_NAME="$(basename "$WORKSPACE")"
  else
    WORKSPACE="$PROJECTS_DIR/$PROJECT_NAME"
    if [ ! -d "$WORKSPACE" ]; then
      echo "  Error: Project not found: $WORKSPACE"
      echo ""
      echo "  Available projects:"
      ls "$PROJECTS_DIR"
      exit 1
    fi
  fi
fi

# â”€â”€ Checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
require claudebox "Install from: https://github.com/RchGrav/claudebox"

# Warn if API key is set â€” subscription users don't need it and it overrides OAuth
if [ -n "${ANTHROPIC_API_KEY:-}" ]; then
  echo "  âš   ANTHROPIC_API_KEY is set â€” Claude Code will bill against your API credits."
  echo "     Unset it to use your Pro/Max subscription instead."
  echo ""
fi

# â”€â”€ GitHub setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GITHUB_TOKEN=""
GITHUB_REPO=""
cd "$WORKSPACE"

if is_github_skipped; then
  : # silently skip â€” user said never
elif GITHUB_REPO=$(detect_github_repo); then
  # Existing GitHub repo â€” look up or create token
  GITHUB_TOKEN=$(lookup_token "$GITHUB_REPO")
  if [ -z "$GITHUB_TOKEN" ]; then
    setup_token "$GITHUB_REPO"
  fi
else
  # No GitHub remote â€” offer to create one
  create_github_repo
  # If a repo was just created, set up its token
  if [ -n "$GITHUB_REPO" ]; then
    setup_token "$GITHUB_REPO"
  fi
fi

# â”€â”€ Launch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "  ðŸš€ vibe session starting"
echo "     project : $PROJECT_NAME"
echo "     path    : $WORKSPACE"
[ -n "$GITHUB_REPO" ] && echo "     github  : $GITHUB_REPO"
echo ""

CLAUDEBOX_ARGS=(--dangerously-skip-permissions)
[ "$REBUILD" = true ] && CLAUDEBOX_ARGS+=(--rebuild)

if [ -n "$GITHUB_TOKEN" ]; then
  GITHUB_TOKEN="$GITHUB_TOKEN" claudebox "${CLAUDEBOX_ARGS[@]}"
else
  claudebox "${CLAUDEBOX_ARGS[@]}"
fi
